---
include:
# - docker-compose-acme.yml # uncomment this line to use it
# - docker-compose-phpmyadmin.yml # uncomment this line to use it

# define envs for logic containers
x-policyclue-envs: &policyclue_envs
  DATABASE_URL: mysql+pymysql://pclue:${PCLUE_DB_PW:?error}@db:3306/policycluedb

  ELASTICSEARCH_URL: http://elasticsearch:9200
  ELASTICSEARCH_PASSWORD: ${ELASTIC_PASSWORD:?error}

  PCLUE_PORTAL_URL: ${PCLUE_PORTAL_URL:?error}
  PCLUE_ONPREMISE: ${PCLUE_ONPREMISE:-0}
  PCLUE_SECRET: ${PCLUE_SECRET:?error}
  PCLUE_SESSION_TIMEOUT: ${PCLUE_SESSION_TIMEOUT:-10800}

  MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS}
  MAIL_HOST: ${MAIL_HOST}
  MAIL_PORT: ${MAIL_PORT}
  MAIL_SECURITY: ${MAIL_SECURITY:-tls}
  MAIL_USERNAME: ${MAIL_USERNAME}
  MAIL_PASSWORD: ${MAIL_PASSWORD}

  MSENTRA_CLIENT_ID: ${MSENTRA_CLIENT_ID}
  MSENTRA_CLIENT_SECRET: ${MSENTRA_CLIENT_SECRET}
  MSENTRA_TENANT_ID: ${MSENTRA_TENANT_ID}

  WORKER_SLEEP_INTERVAL: ${WORKER_SLEEP_INTERVAL:-21600}

  TZ: ${TIMEZONE:-Europe/Zurich}

  DEBUG: 0

# define global settings for all swissp containers
x-policyclue-defaults: &policyclue_defaults
  image: registry.khost.ch/policyclue/api:latest
  restart: unless-stopped
  environment:
    <<: *policyclue_envs
  init: true
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL
  read_only: true
  tmpfs:
    - /tmp
    - /var/tmp
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"
  stop_grace_period: 30s

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:9.1.6
    container_name: elasticsearch
    restart: unless-stopped
    networks:
      - backend
    environment:
      discovery.type: single-node
      xpack.security.enabled: true
      xpack.security.http.ssl.enabled: false
      xpack.security.transport.ssl.enabled: false
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD:?error}
      ES_JAVA_OPTS: -Xms512m -Xmx512m
    volumes:
      - es-data:/usr/share/elasticsearch/data
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # ES needs write access to its data dir; keep container R/W
    read_only: false
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -u elastic:$$ELASTIC_PASSWORD http://localhost:9200 >/dev/null"]
      interval: 20s
      timeout: 5s
      retries: 30
  db:
    image: mariadb:11
    container_name: mariadb
    restart: unless-stopped
    networks:
      - backend
    environment:
      MARIADB_RANDOM_ROOT_PASSWORD: 1
      MARIADB_DATABASE: policycluedb
      MARIADB_USER: pclue
      MARIADB_PASSWORD: ${PCLUE_DB_PW:?error}
    volumes:
      - mariadb-data:/var/lib/mysql
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # Minimal capabilities for entrypoint to traverse and adjust /var/lib/mysql
    # while keeping other privileges dropped.
    cap_add:
      - DAC_OVERRIDE
      - DAC_READ_SEARCH
      - CHOWN
      - FOWNER
      - SETGID
      - SETUID
    read_only: false
    tmpfs:
      - /tmp
    healthcheck:
      test: [ "CMD", "healthcheck.sh", "--su-mysql", "--connect", "--innodb_initialized" ]
      interval: 20s
      timeout: 10s
      retries: 10

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    networks:
      - backend
    # disable persistence â†’ pure cache, only internal network
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    read_only: true
    tmpfs:
      - /data
      - /tmp
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 10

  api:
    <<: *policyclue_defaults
    container_name: api
    networks:
      - frontend
      - backend
    entrypoint: ["sh", "-c", "alembic upgrade head && uvicorn main:app --host 0.0.0.0 --port 8000"]
    healthcheck:
      test: ["CMD", "python3", "-c", "import requests, sys; sys.exit(0) if requests.get('http://localhost:8000/docs').ok else sys.exit(1)"]
      interval: 60s
      timeout: 10s
      retries: 5
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=frontend"
      - "traefik.http.routers.api.rule=PathPrefix(`/api`) || PathPrefix(`/docs`) || Path(`/openapi.json`)"
      - "traefik.http.routers.api.entrypoints=web"
      - "traefik.http.routers.api.priority=100"
      - "traefik.http.services.api.loadbalancer.server.port=8000"
    depends_on:
      db:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy

  worker_sync_hostlists:
    <<: *policyclue_defaults
    container_name: worker_sync_hostlists
    networks:
      - backend
    entrypoint: ["sh", "-c", "python3 worker.py sync_hostlists"]
    depends_on:
      db:
        condition: service_healthy
      api:
        condition: service_healthy

  worker_check_licenseusages:
    <<: *policyclue_defaults
    container_name: worker_check_licenseusages
    networks:
      - backend
    entrypoint: ["sh", "-c", "python3 worker.py check_licenseusages"]
    depends_on:
      db:
        condition: service_healthy
      api:
        condition: service_healthy

  worker_purge_pii:
    <<: *policyclue_defaults
    container_name: worker_purge_pii
    networks:
      - backend
    entrypoint: ["sh", "-c", "python3 worker.py purge_pii"]
    depends_on:
      db:
        condition: service_healthy
      api:
        condition: service_healthy

  webapp:
    image: registry.khost.ch/policyclue/webapp:latest
    container_name: webapp
    restart: unless-stopped
    networks:
      - frontend
    user: "0:0"
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp
      - /config
      - /data
    healthcheck:
      test: curl --fail http://localhost || exit 1
      interval: 60s
      timeout: 10s
      retries: 5
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.webapp.rule=PathPrefix(`/`)"
      - "traefik.http.routers.webapp.entrypoints=web"
      - "traefik.http.routers.webapp.priority=1"
      - "traefik.http.services.webapp.loadbalancer.server.port=80"

  traefik:
    image: traefik:3
    container_name: traefik
    restart: unless-stopped
    networks:
      - frontend
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --ping=true
    ports:
      - "80:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 5s
      retries: 3
    depends_on:
      api:
        condition: service_healthy
      webapp:
        condition: service_started

volumes:
  mariadb-data:
  es-data:

networks:
  frontend:
    name: frontend
    driver: bridge
  backend:
    name: backend
    driver: bridge
